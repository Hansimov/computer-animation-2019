<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/p5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.8.0/addons/p5.dom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.9.0/math.min.js"></script>

</head>
<body>

<script>
let dot = math.dot;
let mult = math.multiply;
let add = math.add;
let abs = math.abs;
let sqrt = math.sqrt;
let pi = math.pi;

let wwidth = window.innerWidth-10;
let wheight = window.innerHeight-20;
function setup() {
    createCanvas(wwidth, wheight);
    noStroke();
    background(51);

}

let r = 150;
let [cx,cy] = [wwidth/2,wheight/3*2];
let m1 = 10;
let m2 = 10;
// let d = -0.0;
let g = 98;

let dt = 0.01;
let h = dt;

let a = 0.01;
let para = [];
let xlim = wwidth/4;
let ylim = wheight/2;
let xstep = 0.5;

if (abs(a*xlim*xlim)>ylim) {
    xlim = sqrt(ylim/a);
}
for (let i=-xlim; i<xlim; i+=xstep) {
    para.push([i,-a*i*i]);
}

let u = xlim;
let w = 0;
let ud = 0;
let wd = 0;

function draw() {
    background(51);
    translate(cx,cy);

    noFill();
    stroke(255,0,255);
    strokeWeight(1);

    beginShape();
    for (let i=0; i<para.length;i++)
        curveVertex(para[i][0], para[i][1]);
    endShape();

    p1 = uw2xy1(u,w);
    p2 = uw2xy2(u,w);

    stroke(255,255,0);
    strokeWeight(3);
    line(p1[0],p1[1],p2[0],p2[1]);

    noStroke();
    fill(0,255,255);
    circle(p1[0], p1[1], 10);
    circle(p2[0], p2[1], 10);


    // [ud,wd,u,w] = rk(ud,wd,u,w);
    [ud,wd,u,w] = eu(ud,wd,u,w);
    p1 = uw2xy1(u,w);
    p2 = uw2xy2(u,w);
}

/*  Lagrange multiplier

    x1 = u
    y1 = a*u*u
    x2 = u + r*sin(w)
    y2 = a*u*u - r*cos(w)

    ...

    u" + m2/(m1+m2)*r*w" + 2*g*a*u = 0
    u" + r*w" + g*w = 0

    u" = -(1+m/M)*2*g*a*u + m/M*g*w
    w" = (M+m)/(M*r)*(2*g*a*u-g*w)

    [u",w"] = f(u,w)

    ud = u'
    wd = w'
    u' = u' + u"*h
    w' = w' + w"*h
*/

function uw2xy1(u,w){
    return [u, -a*u*u];
}
function uw2xy2(u, w){
    return [u + r*sin(w), -a*u*u + r*cos(w)];
}

function uw2uwdd(u,w) {
    return [-(1+m2/m1)*2*g*a*u + m2/m1*g*w, (m1+m2)/(m1*r)*(2*g*a*u-g*w)];
}
// function uwdd2uwd(udd,wdd,ud,wd,hh){
//     return [ud+udd*h, wd+wdd*h];
// }
// function uwd2uw(ud,ud,u,w,hh) {
//     return [u+ud*hh, w+wd*hh];
// }
// function uwdd2uw(udd,wdd,ud,wd,u,w,hh) {
//     let [ud_,wd_] = uwdd2uwd(udd,wdd,ud,wd,hh);
//     return uwd2uw(ud_,wd_,u,w,hh);
// }

//  [ud,wd,u,w] = rk(ud,wd,u,w)
//      [udd,wdd] = uw2wdd(u,w)
//      [ud,wd] = uwdd2uwd(udd,wdd,ud,wd,hh)
//  k(i): [udd,wdd,ud,wd]
//        [udd,wdd,ud,wd] = f(ud,wd,u,w)
//  k(i)   = f(ud,wd,u,w)
//  tmp(i) = [ud,wd,u,w] + ki * hhi
//  k(i+1) = f(tmp(i))
function f(ud,wd,u,w) {
    let [u_,w_] = uw2uwdd(u,w);
    return [ud,wd,u_,w_];
}
function rk(ud,wd,u,w) {
    let k1 = f(ud,wd,u,w);
    let tmp1 = add([ud,wd,u,w], mult(k1,h/2));
    let k2 = f(...tmp1);
    let tmp2 = add([ud,wd,u,w], mult(k2,h/2));
    let k3 = f(...tmp2);
    let tmp3 = add([ud,wd,u,w], mult(k3,h));
    let k4 = f(...tmp3);
    return add([ud,wd,u,w], mult(add(k1,mult(2,k2),mult(2,k3),k4),h/6));
}

function eu(ud,wd,u,w){
    let [udd,wdd] = uw2uwdd(u,w);
    let [ud_,wd_] = [ud+h*udd, wd+h*wdd];
    let [u_,w_] = [u+h*ud_,w+h*wd_];
    return [ud_,wd_,u_,w_];
}

</script>
</body>
</html>